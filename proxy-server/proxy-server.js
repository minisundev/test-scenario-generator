require('dotenv').config();

const express = require('express');
const cors = require('cors');
const fetch = require('node-fetch');

const app = express();
const PORT = process.env.PORT || 3001;

// CORS ÏÑ§Ï†ï
app.use(cors({
  origin: [
    'http://localhost:3000', 
    'http://127.0.0.1:3000',
    'https://dopaminesun-web-app-hxd2dab2d2hwa0d0.eastus2-01.azurewebsites.net'
  ],
  credentials: true
}));

app.use(express.json({ limit: '50mb' }));

// ÌÖçÏä§Ìä∏ ÏöîÏïΩ Ìï®Ïàò
function summarizeContent(content, maxLength = 500) {
  if (!content || content.length <= maxLength) {
    return content || '';
  }
  
  // Ï§ëÏöîÌïú ÏÑπÏÖòÎì§ÏùÑ Ïö∞ÏÑ†Ï†ÅÏúºÎ°ú Ï∂îÏ∂ú (#### Ìó§Îçî Í∏∞Ï§Ä)
  const importantSections = content.match(/(#### .+?\n[\s\S]*?)(?=####|$)/g) || [];
  
  if (importantSections.length > 0) {
    let summary = '';
    for (const section of importantSections) {
      if (summary.length + section.length > maxLength) break;
      summary += section + '\n\n';
    }
    if (summary.length > 0) {
      return summary.trim();
    }
  }
  
  // fallback: Ï≤´ Î∂ÄÎ∂ÑÎßå ÏûêÎ•¥Í∏∞
  return content.substring(0, maxLength) + '...';
}

// Í¥ÄÎ†®ÏÑ± Ï†êÏàò Ï†ïÍ∑úÌôî
function normalizeRelevanceScore(score) {
  // Azure Search Ï†êÏàòÎäî Î≥¥ÌÜµ 0-4 Î≤îÏúÑ, Ïù¥Î•º 0-1Î°ú Ï†ïÍ∑úÌôî
  return Math.min((score || 0) / 4.0, 1.0);
}

// === Î∞©Î≤ï 1: Íµ¨Ï≤¥Ï†ÅÏù∏ OpenAI ÏóîÎìúÌè¨Ïù∏Ìä∏Îì§ ===

// Embeddings API
app.post('/api/openai/deployments/:deploymentName/embeddings', async (req, res) => {
  try {
    const { deploymentName } = req.params;
    const endpoint = process.env.AZURE_OPENAI_ENDPOINT.replace(/\/$/, '');
    const fullOpenAIUrl = `${endpoint}/openai/deployments/${deploymentName}/embeddings?api-version=${process.env.AZURE_OPENAI_API_VERSION}`;
    
    console.log('üîÅ OpenAI Embeddings ÌîÑÎ°ùÏãú ÏöîÏ≤≠:', fullOpenAIUrl);
    console.log('ÏöîÏ≤≠ Î≥∏Î¨∏:', JSON.stringify(req.body, null, 2));
    
    const response = await fetch(fullOpenAIUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'api-key': process.env.AZURE_OPENAI_API_KEY,
      },
      body: JSON.stringify(req.body),
    });

    const data = await response.json();

    if (!response.ok) {
      console.error('‚ùå OpenAI Embeddings API Ïò§Î•ò:', {
        status: response.status,
        statusText: response.statusText,
        url: fullOpenAIUrl,
        error: data
      });
      return res.status(response.status).json(data);
    }

    console.log('‚úÖ OpenAI Embeddings API ÏÑ±Í≥µ:', {
      status: response.status,
      embeddingLength: data.data?.[0]?.embedding?.length
    });

    res.json(data);
  } catch (error) {
    console.error('üî• OpenAI Embeddings ÌîÑÎ°ùÏãú Ïò§Î•ò:', {
      error: error.message,
      stack: error.stack
    });
    res.status(500).json({ error: error.message });
  }
});

// Chat Completions API  
app.post('/api/openai/deployments/:deploymentName/chat/completions', async (req, res) => {
  try {
    const { deploymentName } = req.params;
    const endpoint = process.env.AZURE_OPENAI_ENDPOINT.replace(/\/$/, '');
    const fullOpenAIUrl = `${endpoint}/openai/deployments/${deploymentName}/chat/completions?api-version=${process.env.AZURE_OPENAI_API_VERSION}`;
    
    console.log('üîÅ OpenAI Chat Completions ÌîÑÎ°ùÏãú ÏöîÏ≤≠:', fullOpenAIUrl);
    console.log('ÏöîÏ≤≠ Î≥∏Î¨∏:', JSON.stringify(req.body, null, 2));
    
    const response = await fetch(fullOpenAIUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'api-key': process.env.AZURE_OPENAI_API_KEY,
      },
      body: JSON.stringify(req.body),
    });

    const data = await response.json();

    if (!response.ok) {
      console.error('‚ùå OpenAI Chat Completions API Ïò§Î•ò:', {
        status: response.status,
        statusText: response.statusText,
        url: fullOpenAIUrl,
        error: data
      });
      return res.status(response.status).json(data);
    }

    console.log('‚úÖ OpenAI Chat Completions API ÏÑ±Í≥µ:', {
      status: response.status,
      responseLength: data.choices?.[0]?.message?.content?.length
    });

    res.json(data);
  } catch (error) {
    console.error('üî• OpenAI Chat Completions ÌîÑÎ°ùÏãú Ïò§Î•ò:', {
      error: error.message,
      stack: error.stack
    });
    res.status(500).json({ error: error.message });
  }
});

// Completions API (Î†àÍ±∞Ïãú)
app.post('/api/openai/deployments/:deploymentName/completions', async (req, res) => {
  try {
    const { deploymentName } = req.params;
    const endpoint = process.env.AZURE_OPENAI_ENDPOINT.replace(/\/$/, '');
    const fullOpenAIUrl = `${endpoint}/openai/deployments/${deploymentName}/completions?api-version=${process.env.AZURE_OPENAI_API_VERSION}`;
    
    console.log('üîÅ OpenAI Completions ÌîÑÎ°ùÏãú ÏöîÏ≤≠:', fullOpenAIUrl);
    console.log('ÏöîÏ≤≠ Î≥∏Î¨∏:', JSON.stringify(req.body, null, 2));
    
    const response = await fetch(fullOpenAIUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'api-key': process.env.AZURE_OPENAI_API_KEY,
      },
      body: JSON.stringify(req.body),
    });

    const data = await response.json();

    if (!response.ok) {
      console.error('‚ùå OpenAI Completions API Ïò§Î•ò:', {
        status: response.status,
        statusText: response.statusText,
        url: fullOpenAIUrl,
        error: data
      });
      return res.status(response.status).json(data);
    }

    console.log('‚úÖ OpenAI Completions API ÏÑ±Í≥µ:', {
      status: response.status,
      responseLength: data.choices?.[0]?.text?.length
    });

    res.json(data);
  } catch (error) {
    console.error('üî• OpenAI Completions ÌîÑÎ°ùÏãú Ïò§Î•ò:', {
      error: error.message,
      stack: error.stack
    });
    res.status(500).json({ error: error.message });
  }
});

// === Î∞©Î≤ï 2: ÎßåÎä• ÎùºÏö∞ÌåÖ (fallback) ===
// ÏúÑÏùò Íµ¨Ï≤¥Ï†ÅÏù∏ ÎùºÏö∞ÌåÖÏúºÎ°ú Ï≤òÎ¶¨ÎêòÏßÄ ÏïäÏùÄ Îã§Î•∏ OpenAI API Í≤ΩÎ°úÎì§ÏùÑ Ï≤òÎ¶¨
app.use('/api/openai', async (req, res) => {
  try {
    const relativePath = req.originalUrl.replace('/api/openai', '');
    
    // '/openai'Î•º Í∞ïÏ†úÎ°ú Î∂ôÏûÑ (env ÏàòÏ†ï ÏóÜÏù¥)
    const endpoint = process.env.AZURE_OPENAI_ENDPOINT.replace(/\/$/, '');
    const fullOpenAIUrl = `${endpoint}/openai${relativePath}?api-version=${process.env.AZURE_OPENAI_API_VERSION}`;
    
    console.log('üîÅ OpenAI ÏùºÎ∞ò ÌîÑÎ°ùÏãú ÏöîÏ≤≠:', {
      method: req.method,
      originalUrl: req.originalUrl,
      relativePath: relativePath,
      fullUrl: fullOpenAIUrl
    });
    
    const response = await fetch(fullOpenAIUrl, {
      method: req.method,
      headers: {
        'Content-Type': 'application/json',
        'api-key': process.env.AZURE_OPENAI_API_KEY,
      },
      body: req.method !== 'GET' ? JSON.stringify(req.body) : undefined,
    });

    const data = await response.json();

    if (!response.ok) {
      console.error('‚ùå OpenAI ÏùºÎ∞ò API Ïò§Î•ò:', {
        status: response.status,
        statusText: response.statusText,
        url: fullOpenAIUrl,
        error: data
      });
      return res.status(response.status).json(data);
    }

    console.log('‚úÖ OpenAI ÏùºÎ∞ò API ÏÑ±Í≥µ:', {
      status: response.status,
      url: fullOpenAIUrl
    });

    res.json(data);
  } catch (error) {
    console.error('üî• OpenAI ÏùºÎ∞ò ÌîÑÎ°ùÏãú Ïò§Î•ò:', {
      error: error.message,
      stack: error.stack,
      url: req.originalUrl
    });
    res.status(500).json({ error: error.message });
  }
});

// === Azure AI Search ÏóîÎìúÌè¨Ïù∏Ìä∏ ===

// Ïù∏Îç±Ïä§ ÏÉùÏÑ±
app.post('/api/search/create-index', async (req, res) => {
  try {
    const { indexName } = req.body;
    const url = `${process.env.AZURE_SEARCH_ENDPOINT}/indexes/${indexName}?api-version=2023-11-01`;
    
    const indexSchema = {
      name: indexName,
      fields: [
        {
          name: 'id',
          type: 'Edm.String',
          key: true,
          searchable: false,
          filterable: false,
          sortable: false,
          facetable: false
        },
        {
          name: 'title',
          type: 'Edm.String',
          searchable: true,
          filterable: true,
          sortable: true,
          facetable: false
        },
        {
          name: 'content',
          type: 'Edm.String',
          searchable: true,
          filterable: false,
          sortable: false,
          facetable: false
        },
        {
          name: 'category',
          type: 'Edm.String',
          searchable: true,
          filterable: true,
          sortable: true,
          facetable: true
        },
        {
          name: 'filename',
          type: 'Edm.String',
          searchable: true,
          filterable: true,
          sortable: true,
          facetable: false
        },
        {
          name: 'contentVector',
          type: 'Collection(Edm.Single)',
          searchable: true,
          filterable: false,
          sortable: false,
          facetable: false,
          dimensions: 1536,
          vectorSearchProfile: 'defaultProfile'
        }
      ],
      vectorSearch: {
        profiles: [
          {
            name: 'defaultProfile',
            algorithm: 'defaultAlgorithm'
          }
        ],
        algorithms: [
          {
            name: 'defaultAlgorithm',
            kind: 'hnsw',
            hnswParameters: {
              metric: 'cosine',
              m: 4,
              efConstruction: 400,
              efSearch: 500
            }
          }
        ]
      }
    };
    
    console.log('Ïù∏Îç±Ïä§ ÏÉùÏÑ± ÏöîÏ≤≠:', url);
    
    const response = await fetch(url, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'api-key': process.env.AZURE_SEARCH_API_KEY,
      },
      body: JSON.stringify(indexSchema),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Ïù∏Îç±Ïä§ ÏÉùÏÑ± Ïò§Î•ò:', response.status, errorText);
      return res.status(response.status).json({ error: errorText });
    }

    const data = await response.json();
    res.json(data);
  } catch (error) {
    console.error('Ïù∏Îç±Ïä§ ÏÉùÏÑ± ÌîÑÎ°ùÏãú Ïò§Î•ò:', error);
    res.status(500).json({ error: error.message });
  }
});

// Îã®Ïùº Î¨∏ÏÑú Ïù∏Îç±Ïã±
app.post('/api/search/index-document', async (req, res) => {
  try {
    const { id, title, content, filename, category, contentVector } = req.body;
    const indexName = 'security-docs-index';
    const url = `${process.env.AZURE_SEARCH_ENDPOINT}/indexes/${indexName}/docs/index?api-version=2023-11-01`;
    
    const document = {
      value: [
        {
          '@search.action': 'upload',
          id: id,
          title: title,
          content: content,
          filename: filename,
          category: category,
          contentVector: contentVector
        }
      ]
    };
    
    console.log('Î¨∏ÏÑú Ïù∏Îç±Ïã± ÏöîÏ≤≠:', url);
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'api-key': process.env.AZURE_SEARCH_API_KEY,
      },
      body: JSON.stringify(document),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Î¨∏ÏÑú Ïù∏Îç±Ïã± Ïò§Î•ò:', response.status, errorText);
      return res.status(response.status).json({ error: errorText });
    }

    const data = await response.json();
    res.json(data);
  } catch (error) {
    console.error('Î¨∏ÏÑú Ïù∏Îç±Ïã± ÌîÑÎ°ùÏãú Ïò§Î•ò:', error);
    res.status(500).json({ error: error.message });
  }
});

// Î∞∞Ïπò Î¨∏ÏÑú Ïù∏Îç±Ïã±
app.post('/api/search/index-documents', async (req, res) => {
  try {
    const { documents } = req.body;
    const indexName = 'security-docs-index';
    const url = `${process.env.AZURE_SEARCH_ENDPOINT}/indexes/${indexName}/docs/index?api-version=2023-11-01`;
    
    const batch = {
      value: documents.map(doc => ({
        '@search.action': 'upload',
        ...doc
      }))
    };
    
    console.log('Î∞∞Ïπò Î¨∏ÏÑú Ïù∏Îç±Ïã± ÏöîÏ≤≠:', url);
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'api-key': process.env.AZURE_SEARCH_API_KEY,
      },
      body: JSON.stringify(batch),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Î∞∞Ïπò Î¨∏ÏÑú Ïù∏Îç±Ïã± Ïò§Î•ò:', response.status, errorText);
      return res.status(response.status).json({ error: errorText });
    }

    const data = await response.json();
    res.json(data);
  } catch (error) {
    console.error('Î∞∞Ïπò Î¨∏ÏÑú Ïù∏Îç±Ïã± ÌîÑÎ°ùÏãú Ïò§Î•ò:', error);
    res.status(500).json({ error: error.message });
  }
});

// ÌïòÏù¥Î∏åÎ¶¨Îìú Í≤ÄÏÉâ
app.post('/api/search/hybrid-search', async (req, res) => {
  try {
    const { 
      query, 
      queryVector, 
      top = 5, 
      select,
      highlight,
      highlightPreTag = '<mark>',
      highlightPostTag = '</mark>',
      searchMode = 'any'
    } = req.body;
    
    const indexName = 'security-docs-index';
    const url = `${process.env.AZURE_SEARCH_ENDPOINT}/indexes/${indexName}/docs/search?api-version=2023-11-01`;
    
    const searchBody = {
      search: query || '*',
      top: top,
      select: select || 'id,title,filename,category',
      searchMode: searchMode,
      queryType: 'full',
      searchFields: 'title,content,category'
    };

    // ÌïòÏù¥ÎùºÏù¥Ìä∏ ÏÑ§Ï†ï Ï∂îÍ∞Ä
    if (highlight) {
      searchBody.highlight = highlight;
      searchBody.highlightPreTag = highlightPreTag;
      searchBody.highlightPostTag = highlightPostTag;
    }

    // Î≤°ÌÑ∞ Í≤ÄÏÉâ Ï∂îÍ∞Ä (ÌïòÏù¥Î∏åÎ¶¨Îìú Í≤ÄÏÉâ)
    if (queryVector && queryVector.length > 0) {
      searchBody.vectors = [
        {
          value: queryVector,
          fields: 'contentVector',
          k: top
        }
      ];
    }
    
    console.log('ÌïòÏù¥Î∏åÎ¶¨Îìú Í≤ÄÏÉâ ÏöîÏ≤≠:', url);
    console.log('Í≤ÄÏÉâ Î≥∏Î¨∏:', JSON.stringify(searchBody, null, 2));
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'api-key': process.env.AZURE_SEARCH_API_KEY,
      },
      body: JSON.stringify(searchBody),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('ÌïòÏù¥Î∏åÎ¶¨Îìú Í≤ÄÏÉâ Ïò§Î•ò:', response.status, errorText);
      return res.status(response.status).json({ error: errorText });
    }

    const data = await response.json();
    console.log('Azure Search ÏùëÎãµ:', JSON.stringify(data, null, 2));
    
    // Í≤∞Í≥º ÌõÑÏ≤òÎ¶¨ - content ÏöîÏïΩ Î∞è ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï≤òÎ¶¨
    const results = data.value.map((item, index) => {
      let processedContent = '';
      
      // ÌïòÏù¥ÎùºÏù¥Ìä∏Îêú contentÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏Í≤ÉÏùÑ ÏÇ¨Ïö©
      if (item['@search.highlights'] && item['@search.highlights'].content) {
        processedContent = item['@search.highlights'].content
          .slice(0, 3) // ÏÉÅÏúÑ 3Í∞ú ÌïòÏù¥ÎùºÏù¥Ìä∏Îßå
          .join('... ')
          .substring(0, 800) + '...';
      } else if (item.content) {
        // ÌïòÏù¥ÎùºÏù¥Ìä∏Í∞Ä ÏóÜÏúºÎ©¥ ÏõêÎ≥∏ content ÏöîÏïΩ
        processedContent = summarizeContent(item.content, 800);
      }
      
      return {
        id: item.id || `result_${index}`,
        title: item.title || 'Ï†úÎ™© ÏóÜÏùå',
        content: processedContent,
        filename: item.filename || '',
        category: item.category || 'ÏùºÎ∞ò',
        relevance: normalizeRelevanceScore(item['@search.score']),
        '@search.score': item['@search.score'],
        '@search.highlights': item['@search.highlights']
      };
    });

    console.log(`Í≤ÄÏÉâ Í≤∞Í≥º ÌõÑÏ≤òÎ¶¨ ÏôÑÎ£å: ${results.length}Í∞ú`);
    res.json({ results });
  } catch (error) {
    console.error('ÌïòÏù¥Î∏åÎ¶¨Îìú Í≤ÄÏÉâ ÌîÑÎ°ùÏãú Ïò§Î•ò:', error);
    res.status(500).json({ error: error.message });
  }
});

// Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Í≤ÄÏÉâ
app.post('/api/search/category-search', async (req, res) => {
  try {
    const { 
      category, 
      query = '*',
      select,
      highlight,
      highlightPreTag = '<mark>',
      highlightPostTag = '</mark>'
    } = req.body;
    
    const indexName = 'security-docs-index';
    const url = `${process.env.AZURE_SEARCH_ENDPOINT}/indexes/${indexName}/docs/search?api-version=2023-11-01`;
    
    const searchBody = {
      search: query,
      filter: `category eq '${category}'`,
      top: 10,
      select: select || 'id,title,filename,category'
    };
    
    // ÌïòÏù¥ÎùºÏù¥Ìä∏ ÏÑ§Ï†ï Ï∂îÍ∞Ä
    if (highlight) {
      searchBody.highlight = highlight;
      searchBody.highlightPreTag = highlightPreTag;
      searchBody.highlightPostTag = highlightPostTag;
    }
    
    console.log('Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Í≤ÄÏÉâ ÏöîÏ≤≠:', url);
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'api-key': process.env.AZURE_SEARCH_API_KEY,
      },
      body: JSON.stringify(searchBody),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Í≤ÄÏÉâ Ïò§Î•ò:', response.status, errorText);
      return res.status(response.status).json({ error: errorText });
    }

    const data = await response.json();
    
    // Í≤∞Í≥º ÌõÑÏ≤òÎ¶¨ - ÎèôÏùºÌïú Î°úÏßÅ Ï†ÅÏö©
    const results = data.value.map((item, index) => {
      let processedContent = '';
      
      if (item['@search.highlights'] && item['@search.highlights'].content) {
        processedContent = item['@search.highlights'].content
          .slice(0, 3)
          .join('... ')
          .substring(0, 800) + '...';
      } else if (item.content) {
        processedContent = summarizeContent(item.content, 800);
      }
      
      return {
        id: item.id || `category_result_${index}`,
        title: item.title || 'Ï†úÎ™© ÏóÜÏùå',
        content: processedContent,
        filename: item.filename || '',
        category: item.category || 'ÏùºÎ∞ò',
        relevance: normalizeRelevanceScore(item['@search.score']),
        '@search.score': item['@search.score'],
        '@search.highlights': item['@search.highlights']
      };
    });

    res.json({ results });
  } catch (error) {
    console.error('Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Í≤ÄÏÉâ ÌîÑÎ°ùÏãú Ïò§Î•ò:', error);
    res.status(500).json({ error: error.message });
  }
});

// Ïù∏Îç±Ïä§ ÏÉÅÌÉú ÌôïÏù∏
app.get('/api/search/index-stats', async (req, res) => {
  try {
    const indexName = 'security-docs-index';
    const url = `${process.env.AZURE_SEARCH_ENDPOINT}/indexes/${indexName}/stats?api-version=2023-11-01`;
    
    console.log('Ïù∏Îç±Ïä§ ÏÉÅÌÉú ÌôïÏù∏ ÏöîÏ≤≠:', url);
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'api-key': process.env.AZURE_SEARCH_API_KEY,
      },
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Ïù∏Îç±Ïä§ ÏÉÅÌÉú ÌôïÏù∏ Ïò§Î•ò:', response.status, errorText);
      return res.status(response.status).json({ error: errorText });
    }

    const data = await response.json();
    res.json({
      documentCount: data.documentCount || 0,
      storageSize: data.storageSize || 0
    });
  } catch (error) {
    console.error('Ïù∏Îç±Ïä§ ÏÉÅÌÉú ÌôïÏù∏ ÌîÑÎ°ùÏãú Ïò§Î•ò:', error);
    res.status(500).json({ error: error.message });
  }
});

// Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú
app.delete('/api/search/delete-index', async (req, res) => {
  try {
    const { indexName } = req.body;
    const url = `${process.env.AZURE_SEARCH_ENDPOINT}/indexes/${indexName}?api-version=2023-11-01`;
    
    console.log('Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú ÏöîÏ≤≠:', url);
    
    const response = await fetch(url, {
      method: 'DELETE',
      headers: {
        'api-key': process.env.AZURE_SEARCH_API_KEY,
      },
    });

    if (!response.ok && response.status !== 404) {
      const errorText = await response.text();
      console.error('Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú Ïò§Î•ò:', response.status, errorText);
      return res.status(response.status).json({ error: errorText });
    }

    res.json({ success: true });
  } catch (error) {
    console.error('Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú ÌîÑÎ°ùÏãú Ïò§Î•ò:', error);
    res.status(500).json({ error: error.message });
  }
});

// Ïù∏Îç±Ïä§ Ï°¥Ïû¨ Ïó¨Î∂Ä ÌôïÏù∏
app.post('/api/search/index-exists', async (req, res) => {
  try {
    const { indexName } = req.body;
    const url = `${process.env.AZURE_SEARCH_ENDPOINT}/indexes/${indexName}?api-version=2023-11-01`;
    
    console.log('Ïù∏Îç±Ïä§ Ï°¥Ïû¨ Ïó¨Î∂Ä ÌôïÏù∏ ÏöîÏ≤≠:', url);
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'api-key': process.env.AZURE_SEARCH_API_KEY,
      },
    });

    res.json({ exists: response.ok });
  } catch (error) {
    console.error('Ïù∏Îç±Ïä§ Ï°¥Ïû¨ Ïó¨Î∂Ä ÌôïÏù∏ ÌîÑÎ°ùÏãú Ïò§Î•ò:', error);
    res.json({ exists: false });
  }
});

// === Í∏∞Ï°¥ ÏóîÎìúÌè¨Ïù∏Ìä∏ Ïú†ÏßÄ ===

// Azure AI Search ÌîÑÎ°ùÏãú - Ïù∏Îç±Ïä§ Í¥ÄÎ¶¨
app.put('/api/search/indexes/:indexName', async (req, res) => {
  try {
    const { indexName } = req.params;
    const url = `${process.env.AZURE_SEARCH_ENDPOINT}/indexes/${indexName}?api-version=2023-11-01`;
    
    console.log('Ïù∏Îç±Ïä§ ÏÉùÏÑ± ÏöîÏ≤≠:', url);
    
    const response = await fetch(url, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'api-key': process.env.AZURE_SEARCH_API_KEY,
      },
      body: JSON.stringify(req.body),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Ïù∏Îç±Ïä§ ÏÉùÏÑ± Ïò§Î•ò:', response.status, errorText);
      return res.status(response.status).json({ error: errorText });
    }

    const data = await response.json();
    res.json(data);
  } catch (error) {
    console.error('Ïù∏Îç±Ïä§ ÏÉùÏÑ± ÌîÑÎ°ùÏãú Ïò§Î•ò:', error);
    res.status(500).json({ error: error.message });
  }
});

// Azure AI Search ÌîÑÎ°ùÏãú - Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú
app.delete('/api/search/indexes/:indexName', async (req, res) => {
  try {
    const { indexName } = req.params;
    const url = `${process.env.AZURE_SEARCH_ENDPOINT}/indexes/${indexName}?api-version=2023-11-01`;
    
    console.log('Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú ÏöîÏ≤≠:', url);
    
    const response = await fetch(url, {
      method: 'DELETE',
      headers: {
        'api-key': process.env.AZURE_SEARCH_API_KEY,
      },
    });

    if (!response.ok && response.status !== 404) {
      const errorText = await response.text();
      console.error('Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú Ïò§Î•ò:', response.status, errorText);
      return res.status(response.status).json({ error: errorText });
    }

    res.json({ success: true });
  } catch (error) {
    console.error('Ïù∏Îç±Ïä§ ÏÇ≠Ï†ú ÌîÑÎ°ùÏãú Ïò§Î•ò:', error);
    res.status(500).json({ error: error.message });
  }
});

// Azure AI Search ÌîÑÎ°ùÏãú - Î¨∏ÏÑú Ïù∏Îç±Ïã±
app.post('/api/search/indexes/:indexName/docs/index', async (req, res) => {
  try {
    const { indexName } = req.params;
    const url = `${process.env.AZURE_SEARCH_ENDPOINT}/indexes/${indexName}/docs/index?api-version=2023-11-01`;
    
    console.log('Î¨∏ÏÑú Ïù∏Îç±Ïã± ÏöîÏ≤≠:', url);
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'api-key': process.env.AZURE_SEARCH_API_KEY,
      },
      body: JSON.stringify(req.body),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Î¨∏ÏÑú Ïù∏Îç±Ïã± Ïò§Î•ò:', response.status, errorText);
      return res.status(response.status).json({ error: errorText });
    }

    const data = await response.json();
    res.json(data);
  } catch (error) {
    console.error('Î¨∏ÏÑú Ïù∏Îç±Ïã± ÌîÑÎ°ùÏãú Ïò§Î•ò:', error);
    res.status(500).json({ error: error.message });
  }
});

// Azure AI Search ÌîÑÎ°ùÏãú - Î¨∏ÏÑú Í≤ÄÏÉâ
app.post('/api/search/indexes/:indexName/docs/search', async (req, res) => {
  try {
    const { indexName } = req.params;
    const url = `${process.env.AZURE_SEARCH_ENDPOINT}/indexes/${indexName}/docs/search?api-version=2023-11-01`;
    
    console.log('Î¨∏ÏÑú Í≤ÄÏÉâ ÏöîÏ≤≠:', url);
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'api-key': process.env.AZURE_SEARCH_API_KEY,
      },
      body: JSON.stringify(req.body),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Î¨∏ÏÑú Í≤ÄÏÉâ Ïò§Î•ò:', response.status, errorText);
      return res.status(response.status).json({ error: errorText });
    }

    const data = await response.json();
    res.json(data);
  } catch (error) {
    console.error('Î¨∏ÏÑú Í≤ÄÏÉâ ÌîÑÎ°ùÏãú Ïò§Î•ò:', error);
    res.status(500).json({ error: error.message });
  }
});

// Ìó¨Ïä§ Ï≤¥ÌÅ¨
app.get('/api/health', (req, res) => {
  res.json({ 
    status: 'OK', 
    timestamp: new Date().toISOString(),
    environment: {
      openaiConfigured: !!process.env.AZURE_OPENAI_API_KEY,
      searchConfigured: !!process.env.AZURE_SEARCH_API_KEY
    }
  });
});

// 404 Ï≤òÎ¶¨
app.use('*', (req, res) => {
  console.log('‚ùå 404 Not Found:', {
    method: req.method,
    url: req.originalUrl,
    headers: req.headers
  });
  res.status(404).json({ error: 'Not found' });
});

app.listen(PORT, '0.0.0.0', () => {
  console.log(`üöÄ ÌîÑÎ°ùÏãú ÏÑúÎ≤ÑÍ∞Ä http://0.0.0.0:${PORT} ÏóêÏÑú Ïã§Ìñâ Ï§ëÏûÖÎãàÎã§.`);
  console.log(`üîß ÌôòÍ≤ΩÎ≥ÄÏàò ÏÉÅÌÉú:`);
  console.log(`   - OpenAI API: ${process.env.AZURE_OPENAI_API_KEY ? '‚úÖ ÏÑ§Ï†ïÎê®' : '‚ùå ÎØ∏ÏÑ§Ï†ï'}`);
  console.log(`   - Search API: ${process.env.AZURE_SEARCH_API_KEY ? '‚úÖ ÏÑ§Ï†ïÎê®' : '‚ùå ÎØ∏ÏÑ§Ï†ï'}`);
  console.log(`üéØ ÏßÄÏõêÌïòÎäî OpenAI ÏóîÎìúÌè¨Ïù∏Ìä∏:`);
  console.log(`   - POST /api/openai/deployments/:deploymentName/embeddings`);
  console.log(`   - POST /api/openai/deployments/:deploymentName/chat/completions`);
  console.log(`   - POST /api/openai/deployments/:deploymentName/completions`);
  console.log(`   - Í∏∞ÌÉÄ OpenAI API (fallback ÎùºÏö∞ÌåÖ)`);
});